<%= content_for :bodyclass do %>como-funciona<% end %> 
<% content_for :title, "Proceso de firma electrónica"%>

<%- content_for(:head) do -%>
<%= javascript_include_tag "miniapplet-full.js", "https://www.java.com/js/deployJava.js" -%>
<%- end -%>

<script type="text/javascript">
	$(window).load(function() {
		$('#Espera').hide();
	});
	
	var errorJava = "No tiene instalado Java, no está actualizado en su navegador o no está activado el plug-in. Para acceder con certificado necesita tener instalado el componente Java. Puede descargarlo e instalarlo desde http://www.java.com";

	if (deployJava.isPluginInstalled()) {
		MiniApplet.cargarMiniApplet('/javascripts');
	}
	else {
		alert(errorJava);
		MiniApplet.cargarMiniApplet('/javascripts');
	}
	
	function doSign() {
		
		var dataB64 = document.getElementById("xmlOCE2").value ;
		try {
		
			var params = "format=XAdES Detached\nfilter=signingcert\nmode=implicit"
		
			var signature = MiniApplet.sign(
				dataB64,
				"SHA512withRSA",
				"XAdES",
				params);
		
			if (signature != null) {
				document.forms[0].xmlSigned2.value = signature;
				document.forms[0].submit();
			}
			else {
				alert("Error en el proceso de firma. Compruebe que tiene algún certificado instalado o que el DNIe funcione correctamente.");
			}
		}
		catch (e) {
			var msg;
			msg = MiniApplet.getErrorType();
			if (msg != null) {
				if (msg.indexOf("AOCertificatesNotFoundException") != -1) {
					alert("Error: No se ha encontrado ningún certificado de firma válido");
				}
				else if (msg.indexOf("AOCancelledOperationException") != -1) {
					alert("Se ha cancelado la operación");
				}
				else {
					alert("Error: Se produjo un error durante la operación de firma");
					alert(MiniApplet.getErrorMessage());
				}
			}
		}
		
	}
	
</script>

	
