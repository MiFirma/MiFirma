<script type="text/javascript">
    $(document).ready(function(){
        $("select#signature_province_id").change(function(){
            var id_value_string = $(this).val();
            if (id_value_string == "") {
                // if the id is empty remove all the sub_selection options from being selectable and do not do any ajax
                $("select#signature_municipality_id option").remove();
                var row = "<option value=\"" + "" + "\">" + "" + "</option>";
                $(row).appendTo("select#signature_municipality_id");
            }
            else {
                // Send the request and update sub category dropdown
                $.ajax({
                    dataType: "json",
                    cache: false,
                    url: '/province/municipalities_for_provinceid/' + id_value_string,
                    timeout: 2000,
                    error: function(XMLHttpRequest, errorTextStatus, error){
                        alert("Failed to submit : "+ errorTextStatus+" ;"+error);
                    },
                    success: function(data){                    
                        // Clear all options from sub category select
                        $("select#signature_municipality_id option").remove();
                        //put in a empty default line
                        var row = "<option value=\"" + "" + "\">" + "" + "</option>";
                        $(row).appendTo("select#signature_municipality_id");                        
                        // Fill sub category select
                        $.each(data, function(i, j){
                            row = "<option value=\"" + j.municipality.id + "\">" + j.municipality.name + "</option>";  
                            $(row).appendTo("select#signature_municipality_id");                    
                        });            
                     }
                });
            };
                });
    });
</script>


<div class="signatures_counter">
  <h4><strong><%= @proposal.num_signatures %></strong> firma<%= "s" if @proposal.num_signatures != 1 %></h4>
  
  <div class="graph">
    <div class="num" style="width:<%= (220 * @proposal.precent_remaining_signatures).ceil + 30 %>px;"></div>
    <div class="total">Faltan <%= @proposal.num_remaining_signatures %></div>
  </div>
  
</div>

<div class="form_container">

  <% if flash[:error] %>
  <div class="sign_error">
    <strong>Error al crear la firma.</strong>
    <%= flash[:error].html_safe %>
  </div>
  <% end %>
  
  <%= form_for @signature do |f| %>
  <div class="form">
    
    <label for="name">Provincia</label>
    <div class="input">
			<%= f.select :province_id, @provinces.collect {|p| [p.name,p.id]}, { :include_blank => true } %>
    </div>

    <label for="name">Municipio</label>
    <div class="input">
			<%= f.select :municipality_id, Municipality.find_all_by_province_id(@signature.province_id).collect {|p| [p.name,p.id]}, { :include_blank => true } %>
    </div>
    
    <label for="email">Tu email</label>
    <div class="input">
      <%= f.hidden_field :proposal_id %>
      <%= f.text_field :email %>
    </div>

    <div class="tos">
      <%= f.check_box :terms %>
      Acepto los <a href="#">términos y condiciones</a>
    </div>
    
  </div>

  <div class="btn_sign">
    <a href="#" onclick="$('#new_signature').submit(); return false;">Firma electónica</a>
  </div>
  
  
  <% end %>
</div>

<div class="tradicional">
  <p>
    Si no dispones de <strong>DNI electrónico</strong> puedes mostrar tu apoyo con una <a href="#" onclick="alert('Próximamente en MiFirma'); return false;">firma tradicional</a>
  </p>
</div>
